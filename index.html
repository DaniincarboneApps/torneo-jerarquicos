<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Torneo B√°squet ‚Äî Jer√°rquicos</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<style>
:root{
  --bg:#041028; --panel:#07172a; --card:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  --accent:#1e90ff; --accent-2:#f59e0b; --muted:#9fb0c6; --text:#eaf2ff; --glass:rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#041028 0%, #02243a 100%);color:var(--text);-webkit-font-smoothing:antialiased}
.app{max-width:1180px;margin:14px auto;padding:12px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#072033,#0b3a56);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px}
.title{line-height:1}
.title h1{margin:0;font-size:18px}
.title p{margin:2px 0 0;color:var(--muted);font-size:13px}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center}
.input{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);min-width:260px}
.btn{background:var(--accent);color:#021028;border:0;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
.btn.alt{background:var(--accent-2);color:#021028}
.layout{display:grid;grid-template-columns:260px 1fr;gap:12px}
@media(max-width:880px){ .layout{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} .controls .input{min-width:140px} }
.sidebar{background:var(--panel);padding:12px;border-radius:12px;min-height:360px}
.nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:10px;border-radius:8px;border:0;background:transparent;color:var(--text);text-align:left;margin-bottom:8px;cursor:pointer;font-weight:600}
.nav-btn.active{background:linear-gradient(90deg,var(--accent),#60a5fa);color:#021028}
.section-title{font-size:13px;color:var(--muted);margin-top:8px;margin-bottom:6px}
.card{background:var(--card);padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(2,6,12,0.4)}
.status-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.small{font-size:13px;color:var(--muted)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
.table th{font-size:12px;color:var(--muted)}
.table tbody tr:nth-child(odd){background:rgba(255,255,255,0.01)}
.badge{width:36px;height:36px;border-radius:8px;background:#012233;display:inline-flex;align-items:center;justify-content:center;font-weight:800}
.fixture-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:transparent;margin-bottom:8px}
.meta{color:var(--muted);font-size:13px}
.playoff-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
@media(min-width:900px){ .playoff-grid{grid-template-columns:repeat(4,1fr)} }
.footer{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}
.toast{position:fixed;right:18px;bottom:18px;background:rgba(0,0,0,0.7);color:white;padding:8px 12px;border-radius:8px}
</style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="brand">
        <div class="logo">BB</div>
        <div class="title">
          <h1>TORNEO B√ÅSQUET ‚Äî JER√ÅRQUICOS</h1>
          <p>Ver resultados ¬∑ Fixture ¬∑ Tabla de posiciones ¬∑ Playoffs</p>
        </div>
      </div>

      <div class="controls">
        <input id="csvUrl" class="input" type="text" placeholder="CSV p√∫blica (publicar ‚Üí CSV)"/>
        <button id="saveCsv" class="btn ghost">Guardar URL</button>
        <button id="updateBtn" class="btn">üîÑ Actualizar</button>
        <button id="downloadBtn" class="btn alt">‚¨áÔ∏è Descargar CSV</button>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar">
        <div class="section-title">Navegaci√≥n</div>
        <button class="nav-btn active" data-tab="pos">üèÜ Tabla de Posiciones</button>
        <button class="nav-btn" data-tab="fixture">üìÖ Fixture</button>
        <button class="nav-btn" data-tab="playoffs">‚öîÔ∏è Playoffs</button>
        <button class="nav-btn" data-tab="goleadores">üî• Goleadores</button>
        <button class="nav-btn" data-tab="ingresar">‚úçÔ∏è Ingresar Resultados</button>

        <div class="section-title">Estado</div>
        <div class="card">
          <div class="status-row">
            <div id="statMsg" class="small">Estado: sin cargar</div>
            <div id="lastUpdated" class="small">√öltima: ‚Äî</div>
          </div>
          <div style="margin-top:8px" class="small">Auto-refresh:
            <label style="margin-left:8px"><input id="autoRefresh" type="checkbox"/> 30s</label>
          </div>
        </div>

        <div class="section-title">Instrucciones</div>
        <div class="card small">
          ‚Ä¢ Public√° la hoja ‚Üí CSV. <br>
          ‚Ä¢ Compart√≠ permiso Editor solo a los 1‚Äì3 editores. <br>
          ‚Ä¢ Si no ves datos, prob√° en inc√≥gnito o puls√° Actualizar.
        </div>
      </aside>

      <main class="main">
        <section id="pos" class="card" style="display:block">
          <h3>üèÜ Tabla de Posiciones</h3>
          <div id="standingsTable" style="margin-top:8px"></div>
        </section>

        <section id="fixture" class="card" style="display:none">
          <h3>üìÖ Fixture / Resultados</h3>
          <div id="fixtureList" style="margin-top:8px"></div>
        </section>

        <section id="playoffs" class="card" style="display:none">
          <h3>‚öîÔ∏è Playoffs (Top 8)</h3>
          <div id="playoffBox" class="playoff-grid" style="margin-top:8px"></div>
        </section>

        <section id="goleadores" class="card" style="display:none">
          <h3>üî• Tabla de Goleadores</h3>
          <div id="goleadoresBox" style="margin-top:8px"></div>
        </section>

        <section id="ingresar" class="card" style="display:none">
          <h3>‚úçÔ∏è Ingresar Resultados</h3>
          <div class="small" style="margin-bottom:8px">Edici√≥n por Google Sheets. Solo editores pueden modificar. Si quer√©s edici√≥n desde la web, lo integramos con Firebase m√°s adelante.</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="openSheet" class="btn ghost">Abrir hoja (editor)</button>
            <button id="forceReload" class="btn">Forzar recarga</button>
            <button id="clearSaved" class="btn ghost">Borrar URL guardada</button>
          </div>
        </section>

        <div class="footer">App pro: datos en Google Sheets ¬∑ Compart√≠ el link por WhatsApp / Instagram</div>
      </main>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
(function(){
  const DEFAULT_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfK4mr4OIlKn4GerZ2QDl_h2_YLWgONz3x4MF6jRFaMIPHA6A_-Wv535UB4_dy6N3YOBiq6zORBY7X/pub?gid=1178727492&single=true&output=csv';
  const STORAGE_KEY = 'torneo_csv_url_jr';
  const csvInput = document.getElementById('csvUrl');
  const saveBtn = document.getElementById('saveCsv');
  const updateBtn = document.getElementById('updateBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const autoCheck = document.getElementById('autoRefresh');
  const statMsg = document.getElementById('statMsg');
  const lastUpdated = document.getElementById('lastUpdated');
  const toastEl = document.getElementById('toast');
  const openSheetBtn = document.getElementById('openSheet');
  const clearSavedBtn = document.getElementById('clearSaved');
  const forceReloadBtn = document.getElementById('forceReload');

  let latestMatches = [];
  let autoTimer = null;

  function toast(msg, t=1500){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=> toastEl.style.display='none', t); }

  function parseCSV(text){
    const rows=[]; let cur=''; let row=[]; let inQ=false;
    for (let i=0;i<text.length;i++){ const ch=text[i];
      if (ch === '"'){ if (inQ && text[i+1]==='"'){ cur+='"'; i++; continue } inQ = !inQ; continue; }
      if (!inQ && (ch===',' || ch==='\n' || ch==='\r')){ row.push(cur); cur=''; if (ch==='\r' && text[i+1]==='\n'){ i++; rows.push(row); row=[]; continue } if (ch==='\n' || ch==='\r'){ rows.push(row); row=[]; continue } continue; }
      cur += ch;
    }
    if (cur !== '' || row.length) row.push(cur);
    if (row.length) rows.push(row);
    return rows;
  }

  function loadSaved(){ const v = localStorage.getItem(STORAGE_KEY); if (v) csvInput.value = v; return v; }
  function saveUrl(v){ localStorage.setItem(STORAGE_KEY, v); csvInput.value = v; toast('URL guardada'); }
  function clearSaved(){ localStorage.removeItem(STORAGE_KEY); csvInput.value = ''; toast('URL eliminada'); }

  saveBtn.addEventListener('click', ()=> {
    const v = csvInput.value.trim();
    if (!v) return toast('Pega URL p√∫blica CSV');
    saveUrl(v);
  });

  updateBtn.addEventListener('click', ()=> {
    const url = csvInput.value.trim() || loadSaved() || DEFAULT_CSV;
    if (!url) return toast('No hay URL CSV configurada');
    fetchAndRender(url);
  });

  downloadBtn.addEventListener('click', ()=> {
    if (!latestMatches || !latestMatches.length) return toast('No hay datos para descargar');
    const headers = ['id','jornada','equipo_local','equipo_visita','score_local','score_visita','estado','cancha','fecha','hora','goleadores_local','goleadores_visita'];
    const lines = [headers.join(',')];
    for (const m of latestMatches){
      const cols = headers.map(h=> {
        let v = m[h] ?? '';
        v = String(v);
        if (v.includes('"')) v = v.replace(/"/g,'""');
        if (v.includes(',') || v.includes('"') || v.includes('\n')) v = `"${v}"`;
        return v;
      });
      lines.push(cols.join(','));
    }
    const blob = new Blob([lines.join('\n')], { type:'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'matches_export.csv'; a.click(); URL.revokeObjectURL(a.href);
    toast('CSV descargado');
  });

  autoCheck.addEventListener('change', ()=> {
    if (autoCheck.checked) startAutoRefresh(30);
    else stopAutoRefresh();
  });

  function startAutoRefresh(sec){
    stopAutoRefresh();
    autoTimer = setInterval(()=> {
      const url = csvInput.value.trim() || loadSaved() || DEFAULT_CSV;
      if (url) fetchAndRender(url);
    }, sec*1000);
    toast('Auto-refresh activado');
  }
  function stopAutoRefresh(){ if (autoTimer) clearInterval(autoTimer); autoTimer = null; toast('Auto-refresh detenido'); }

  function getCsvParam(){
    try{ const params = new URLSearchParams(window.location.search); const csvParam = params.get('csv'); return csvParam ? decodeURIComponent(csvParam) : null; } catch(e){ return null; }
  }

  function sanitizeTail(rawUrl){
    const urlBase = rawUrl.split('?')[0];
    const tail = rawUrl.includes('?') ? '?' + rawUrl.split('?')[1] : '?output=csv';
    const cacheBuster = (tail.includes('?') ? '&' : '?') + 't=' + Date.now();
    return urlBase + tail + cacheBuster;
  }

  async function fetchAndRender(rawUrl){
    const url = sanitizeTail(rawUrl);
    statMsg.textContent = 'Estado: cargando...';
    try{
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      if (!text || text.trim().length === 0) throw new Error('CSV vac√≠o');
      const rows = parseCSV(text);
      const header = rows[0].map(h=>String(h||'').trim());
      const data = rows.slice(1).map(r=>{
        const obj = {};
        for (let i=0;i<header.length;i++) obj[header[i]] = (r[i] ?? '').trim();
        obj.jornada = obj.jornada ? Number(obj.jornada) : null;
        obj.score_local = obj.score_local === '' ? null : (isNaN(Number(obj.score_local)) ? obj.score_local : Number(obj.score_local));
        obj.score_visita = obj.score_visita === '' ? null : (isNaN(Number(obj.score_visita)) ? obj.score_visita : Number(obj.score_visita));
        obj.estado = obj.estado ? obj.estado : (obj.score_local != null && obj.score_visita != null ? 'finalizado' : 'programado');
        return obj;
      });
      latestMatches = data;
      renderAll(data);
      lastUpdated.textContent = '√öltima: ' + (new Date()).toLocaleString();
      statMsg.textContent = 'Estado: cargado';
    }catch(err){
      statMsg.textContent = 'Estado: error';
      toast('Error: ' + err.message, 4000);
      console.error(err);
    }
  }

  function aggregateStandings(matches){
    const map={};
    for (const m of matches){
      const a = (m.equipo_local||'').trim(), b=(m.equipo_visita||'').trim();
      if (!a||!b) continue;
      if (!map[a]) map[a]={nombre:a,PJ:0,PG:0,PP:0,PF:0,PC:0};
      if (!map[b]) map[b]={nombre:b,PJ:0,PG:0,PP:0,PF:0,PC:0};
      if (m.score_local==null||m.score_visita==null) continue;
      const la=Number(m.score_local), lb=Number(m.score_visita);
      if (!Number.isFinite(la)||!Number.isFinite(lb)) continue;
      map[a].PJ++; map[b].PJ++;
      map[a].PF+=la; map[a].PC+=lb;
      map[b].PF+=lb; map[b].PC+=la;
      if (la>lb){ map[a].PG++; map[b].PP++; } else if (la<lb){ map[b].PG++; map[a].PP++; }
    }
    const arr = Object.values(map).map(s=>({...s,DF:s.PF-s.PC,PTS:2*s.PG+1*s.PP}));
    arr.sort((x,y)=> y.PTS - x.PTS || y.DF - x.DF || y.PF - x.PF || x.nombre.localeCompare(y.nombre));
    return arr.map((r,i)=>({...r,pos:i+1}));
  }

  function renderStandings(matches){
    const s = aggregateStandings(matches);
    const container = document.getElementById('standingsTable'); container.innerHTML = '';
    if (!s.length){ container.innerHTML = '<div class="small">No hay datos</div>'; return; }
    const table = document.createElement('table'); table.className='table';
    const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Pos</th><th>Equipo</th><th>PJ</th><th>PG</th><th>PP</th><th>PF</th><th>PC</th><th>DF</th><th>PTS</th></tr>';
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    for (const r of s){
      const tr = document.createElement('tr');
      if (r.pos <= 8) tr.style.background='rgba(245,158,11,0.04)';
      tr.innerHTML = `<td>${r.pos}</td><td>${r.nombre}</td><td style="text-align:center">${r.PJ}</td><td style="text-align:center">${r.PG}</td><td style="text-align:center">${r.PP}</td><td style="text-align:center">${r.PF}</td><td style="text-align:center">${r.PC}</td><td style="text-align:center">${r.DF}</td><td style="text-align:center;font-weight:800">${r.PTS}</td>`;
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    container.appendChild(table);
  }

  function renderFixture(matches){
    const container = document.getElementById('fixtureList'); container.innerHTML = '';
    const jornadas = [...new Set(matches.map(m=>m.jornada).filter(v=>v!=null))].sort((a,b)=>a-b);
    if (!jornadas.length){ container.innerHTML = '<div class="small">No hay partidos definidos.</div>'; return; }
    for (const j of jornadas){
      const block = document.createElement('div'); block.style.marginBottom='10px';
      const hdr = document.createElement('div'); hdr.style.display='flex'; hdr.style.justifyContent='space-between'; hdr.innerHTML = `<strong>Jornada ${j}</strong><span class="small">${matches.filter(m=>m.jornada===j).length} partidos</span>`;
      block.appendChild(hdr);
      for (const m of matches.filter(x=>x.jornada===j)){
        const row = document.createElement('div'); row.className='fixture-row';
        const left = document.createElement('div'); left.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div class="badge">${initials(m.equipo_local)}</div><div>${m.equipo_local||'TBD'}</div></div>`;
        const center = document.createElement('div'); center.innerHTML = `<strong>${m.score_local!=null?m.score_local:'-'} ‚Äî ${m.score_visita!=null?m.score_visita:'-'}</strong>`;
        const right = document.createElement('div'); right.innerHTML = `<div style="min-width:140px">${m.equipo_visita||'TBD'}<div class="meta">${m.cancha?m.cancha+' ¬∑ ':''}${m.fecha?m.fecha+' ':''}${m.hora?m.hora:''}</div></div>`;
        row.appendChild(left); row.appendChild(center); row.appendChild(right);
        block.appendChild(row);
      }
      container.appendChild(block);
    }
  }

  function initials(name){ if(!name) return ''; return name.split(' ').map(w=>w[0]||'').slice(0,2).join('').toUpperCase(); }

  function buildPlayoffs(matches){
    const top = aggregateStandings(matches).slice(0,8);
    const pairs = [[1,8],[4,5],[3,6],[2,7]];
    return pairs.map((p,i)=>({match:i+1,home:top[p[0]-1]||null,away:top[p[1]-1]||null}));
  }

  function renderPlayoffs(matches){
    const box = document.getElementById('playoffBox'); box.innerHTML = '';
    const data = buildPlayoffs(matches);
    if (!data.length){ box.innerHTML = '<div class="small">No hay suficientes equipos para playoffs</div>'; return; }
    for (const b of data){
      const el = document.createElement('div'); el.style.padding='10px'; el.style.borderRadius='8px'; el.style.background='rgba(255,255,255,0.01)';
      el.innerHTML = `<div class="small">QF ${b.match}</div><div style="font-weight:700">${b.home?b.home.nombre:'TBD'}</div><div class="small muted">vs</div><div style="font-weight:700">${b.away?b.away.nombre:'TBD'}</div>`;
      box.appendChild(el);
    }
  }

  function parseScorersField(field){
    if (!field) return [];
    return field.split(';').map(s=>s.trim()).filter(Boolean).map(part=>{
      const [name, pts] = part.split(':').map(x=>x && x.trim());
      return { name: name||'', pts: pts ? Number(pts) : 0 };
    });
  }

  function renderGoleadores(matches){
    const box = document.getElementById('goleadoresBox'); box.innerHTML = '';
    const tally = {};
    for (const m of matches){
      const left = parseScorersField(m.goleadores_local);
      const right = parseScorersField(m.goleadores_visita);
      for (const s of [...left,...right]){ if (!s.name) continue; tally[s.name] = (tally[s.name] || 0) + (Number.isFinite(Number(s.pts)) ? Number(s.pts) : 0); }
    }
    const arr = Object.keys(tally).map(n=>({nombre:n,pts:tally[n]})).sort((a,b)=>b.pts - a.pts || a.nombre.localeCompare(b.nombre));
    if (!arr.length){ box.innerHTML = '<div class="small">A√∫n no hay datos de goleadores.</div>'; return; }
    const table = document.createElement('table'); table.className='table';
    table.innerHTML = '<thead><tr><th>#</th><th>Jugador</th><th>Puntos</th></tr></thead>';
    const tbody = document.createElement('tbody');
    arr.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${r.nombre}</td><td style="text-align:right">${r.pts}</td>`; tbody.appendChild(tr); });
    table.appendChild(tbody); box.appendChild(table);
  }

  function renderAll(matches){
    renderStandings(matches);
    renderFixture(matches);
    renderPlayoffs(matches);
    renderGoleadores(matches);
  }

  function init(){
    const param = getCsvParam();
    if (param){ let dec = param; try { dec = decodeURIComponent(param); } catch(e){} saveUrl(dec); fetchAndRender(dec); }
    else {
      const s = loadSaved();
      if (s) fetchAndRender(s);
      else if (DEFAULT_CSV) { saveUrl(DEFAULT_CSV); fetchAndRender(DEFAULT_CSV); }
    }
  }

  openSheetBtn.addEventListener('click', ()=> {
    const url = csvInput.value.trim() || loadSaved() || DEFAULT_CSV;
    const editUrl = url.replace('/pub?','/edit?');
    window.open(editUrl,'_blank');
  });

  clearSavedBtn.addEventListener('click', ()=> clearSaved());
  forceReloadBtn.addEventListener('click', ()=> { const url = csvInput.value.trim() || loadSaved() || DEFAULT_CSV; if (url) fetchAndRender(url); });

  document.querySelectorAll('.nav-btn').forEach(b=>{
    b.addEventListener('click', (e)=> {
      document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
      e.currentTarget.classList.add('active');
      const tab = e.currentTarget.getAttribute('data-tab');
      document.querySelectorAll('main section').forEach(s=>s.style.display='none');
      document.getElementById(tab).style.display='block';
    });
  });

  init();
  window.torneo = { fetchAndRender, renderAll };
})();
</script>
</body>
</html>
