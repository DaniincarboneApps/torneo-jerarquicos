<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Torneo Básquet — Jerárquicos</title>
<style>
:root{
  --bg:#041028; --panel:#07172a; --card:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  --accent:#1e90ff; --accent-2:#f59e0b; --muted:#9fb0c6; --text:#eaf2ff;
  --green:#0f5132; --green-2:#1f7a4f;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#041028,#02243a);color:var(--text);-webkit-font-smoothing:antialiased}
.app{max-width:1200px;margin:14px auto;padding:12px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#072033,#0b3a56);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px}
.title h1{margin:0;font-size:18px}
.title p{margin:2px 0 0;color:var(--muted);font-size:13px}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center}
.input{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);min-width:260px}
.btn{background:var(--accent);color:#021028;border:0;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}

.layout{display:grid;grid-template-columns:260px 1fr;gap:12px;align-items:start}
@media(max-width:880px){ .layout{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} .topnav{display:flex} .leftnav{display:none} .controls .input{min-width:140px} }

.sidebar{background:var(--panel);padding:12px;border-radius:12px;min-height:360px}
.leftnav{display:block}
.topnav{display:none;padding:6px 0;margin-bottom:8px;gap:6px}
.topnav button{flex:1;padding:8px;border-radius:8px;border:0;background:transparent;color:var(--text);font-weight:700}
.nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:10px;border-radius:8px;border:0;background:transparent;color:var(--text);text-align:left;margin-bottom:8px;cursor:pointer;font-weight:600}
.nav-btn.active{background:linear-gradient(90deg,var(--accent),#60a5fa);color:#021028}

.card{background:var(--card);padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(2,6,12,0.4)}
.small{font-size:13px;color:var(--muted)}
.status-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

/* table */
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
.table th{font-size:12px;color:var(--muted)}
.table tbody tr:nth-child(odd){background:rgba(255,255,255,0.01)}

/* fixture */
.jornada-nav{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.jornada-btn{padding:8px 10px;border-radius:8px;border:0;background:transparent;color:var(--text);cursor:pointer}
.jornada-btn.active{background:rgba(255,255,255,0.03)}

/* bracket */
.bracket{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;align-items:start}
.column{background:rgba(255,255,255,0.01);padding:10px;border-radius:10px}
.match{background:linear-gradient(180deg,var(--green),var(--green-2));color:white;padding:8px;border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;opacity:0;transform:translateY(6px)}

/* animations */
.fade-in{animation:fadeIn .28s ease forwards}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.slide-left{animation:slideLeft .28s ease forwards}
@keyframes slideLeft{from{opacity:0;transform:translateX(8px)}to{opacity:1;transform:translateX(0)}}

@media(max-width:540px){ .controls{flex-wrap:wrap;gap:6px} .input{min-width:120px} .bracket{grid-template-columns:1fr} }
.toast{position:fixed;right:18px;bottom:18px;background:rgba(0,0,0,0.7);color:white;padding:8px 12px;border-radius:8px;display:none}
</style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="brand">
        <div class="logo">BB</div>
        <div class="title">
          <h1>TORNEO BÁSQUET — JERÁRQUICOS</h1>
          <p>Resultados · Fixture · Tabla · Playoffs</p>
        </div>
      </div>
      <div class="controls">
        <input id="csvUrl" class="input" type="text" placeholder="CSV pública (publicar → CSV)"/>
        <button id="saveCsv" class="btn ghost">Guardar URL</button>
        <button id="updateBtn" class="btn">🔄 Actualizar</button>
        <label style="color:var(--muted);margin-left:8px"><input id="autoRefresh" type="checkbox" /> Auto-refresh</label>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar">
        <div class="leftnav">
          <div class="small" style="margin-bottom:8px">Navegación</div>
          <button class="nav-btn active" data-tab="pos">🏆 Tabla de Posiciones</button>
          <button class="nav-btn" data-tab="fixture">📅 Fixture</button>
          <button class="nav-btn" data-tab="playoffs">⚔️ Playoffs</button>
          <button class="nav-btn" data-tab="goleadores">🔥 Goleadores</button>
        </div>
      </aside>

      <main class="main">
        <div class="topnav" style="display:none;gap:6px;margin-bottom:12px">
          <button data-tab="pos">🏆 Tabla</button>
          <button data-tab="fixture">📅 Fixture</button>
          <button data-tab="playoffs">⚔️ Playoffs</button>
          <button data-tab="goleadores">🔥 Goleadores</button>
        </div>

        <section id="pos" class="card" style="display:block">
          <h3>🏆 Tabla de Posiciones</h3>
          <div id="standingsTable" style="margin-top:8px" class="fade-in"></div>
        </section>

        <section id="fixture" class="card" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <h3 style="margin:0">📅 Fixture / Resultados</h3>
            <div>
              <button id="prevJ" class="jornada-btn">◀</button>
              <select id="jornadaSelect" class="jornada-btn"></select>
              <button id="nextJ" class="jornada-btn">▶</button>
            </div>
          </div>
          <div id="fixtureList" style="margin-top:6px" class="slide-left"></div>
        </section>

        <section id="playoffs" class="card" style="display:none">
          <h3>⚔️ Playoffs (Top 8)</h3>
          <div id="bracket" class="bracket" style="margin-top:10px"></div>
          <div class="small" style="margin-top:10px">Para automatizar: añadí en la hoja filas de playoff con columna `fase` (ej. QF1,QF2.. SF1,SF2,FINAL) o usá jornadas >=100. Rellená scores y la app completará etapas.</div>
        </section>

        <section id="goleadores" class="card" style="display:none">
          <h3>🔥 Tabla de Goleadores</h3>
          <div id="goleadoresBox" style="margin-top:8px" class="fade-in"></div>
        </section>
      </main>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
(function(){
  const DEFAULT_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfK4mr4OIlKn4GerZ2QDl_h2_YLWgONz3x4MF6jRFaMIPHA6A_-Wv535UB4_dy6N3YOBiq6zORBY7X/pub?gid=1178727492&single=true&output=csv';
  const STORAGE_KEY = 'torneo_csv_url_jr';
  const csvInput = document.getElementById('csvUrl');
  const saveBtn = document.getElementById('saveCsv');
  const updateBtn = document.getElementById('updateBtn');
  const autoCheck = document.getElementById('autoRefresh');
  const toastEl = document.getElementById('toast');

  let latestMatches = [];
  let jornadasSorted = [];
  let currentJornada = null;
  let autoTimer = null;

  function toast(msg, t=1300){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=> toastEl.style.display='none', t); }

  function parseCSV(text){
    const rows=[]; let cur=''; let row=[]; let inQ=false;
    for (let i=0;i<text.length;i++){ const ch = text[i];
      if (ch === '"'){ if (inQ && text[i+1]==='"'){ cur+='"'; i++; continue } inQ = !inQ; continue; }
      if (!inQ && (ch===',' || ch==='\n' || ch==='\r')){ row.push(cur); cur=''; if (ch==='\r' && text[i+1]==='\n'){ i++; rows.push(row); row=[]; continue } if (ch==='\n' || ch==='\r'){ rows.push(row); row=[]; continue } continue; }
      cur += ch;
    }
    if (cur !== '' || row.length) row.push(cur);
    if (row.length) rows.push(row);
    return rows;
  }

  function loadSaved(){ const v = localStorage.getItem(STORAGE_KEY); if (v) csvInput.value = v; return v; }
  function saveUrl(v){ localStorage.setItem(STORAGE_KEY, v); csvInput.value = v; toast('URL guardada'); }
  saveBtn.addEventListener('click', ()=> {
    const v = csvInput.value.trim();
    if (!v) return toast('Pega URL pública CSV');
    saveUrl(v);
  });

  updateBtn.addEventListener('click', ()=> {
    const url = csvInput.value.trim() || loadSaved() || DEFAULT_CSV;
    if (!url) return toast('No hay URL CSV configurada');
    fetchAndRender(url);
  });

  autoCheck.addEventListener('change', ()=> {
    if (autoCheck.checked) startAutoRefresh(30);
    else stopAutoRefresh();
  });

  function startAutoRefresh(sec){
    stopAutoRefresh();
    autoTimer = setInterval(()=> {
      const url = csvInput.value.trim() || loadSaved() || DEFAULT_CSV;
      if (url) fetchAndRender(url);
    }, sec*1000);
    toast('Auto-refresh ON');
  }
  function stopAutoRefresh(){ if (autoTimer) clearInterval(autoTimer); autoTimer = null; toast('Auto-refresh OFF'); }

  function sanitizeTail(rawUrl){
    const urlBase = rawUrl.split('?')[0];
    const tail = rawUrl.includes('?') ? '?' + rawUrl.split('?')[1] : '?output=csv';
    const cacheBuster = (tail.includes('?') ? '&' : '?') + 't=' + Date.now();
    return urlBase + tail + cacheBuster;
  }

  async function fetchAndRender(rawUrl){
    const url = sanitizeTail(rawUrl);
    toast('Cargando...');
    try{
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      if (!text || text.trim().length === 0) throw new Error('CSV vacío');
      const rows = parseCSV(text);
      const header = rows[0].map(h=>String(h||'').trim());
      const data = rows.slice(1).map(r=>{
        const obj = {};
        for (let i=0;i<header.length;i++) obj[header[i]] = (r[i] ?? '').trim();
        obj.jornada = obj.jornada ? Number(obj.jornada) : null;
        obj.score_local = obj.score_local === '' ? null : (isNaN(Number(obj.score_local)) ? obj.score_local : Number(obj.score_local));
        obj.score_visita = obj.score_visita === '' ? null : (isNaN(Number(obj.score_visita)) ? obj.score_visita : Number(obj.score_visita));
        obj.fase = obj.fase ? obj.fase.trim().toUpperCase() : '';
        obj.estado = obj.estado ? obj.estado : (obj.score_local != null && obj.score_visita != null ? 'finalizado' : 'programado');
        return obj;
      });
      latestMatches = data;
      renderAll(data);
      toast('Listo',800);
    }catch(err){
      console.error(err);
      toast('Error: ' + err.message,4000);
    }
  }

  function aggregateStandings(matches){
    const map={};
    for (const m of matches){
      const a=(m.equipo_local||'').trim(), b=(m.equipo_visita||'').trim();
      if (!a || !b) continue;
      if (!map[a]) map[a]={nombre:a,PJ:0,PG:0,PP:0,PF:0,PC:0};
      if (!map[b]) map[b]={nombre:b,PJ:0,PG:0,PP:0,PF:0,PC:0};
      if (m.score_local==null || m.score_visita==null) continue;
      const la=Number(m.score_local), lb=Number(m.score_visita);
      if (!Number.isFinite(la)||!Number.isFinite(lb)) continue;
      map[a].PJ++; map[b].PJ++;
      map[a].PF+=la; map[a].PC+=lb;
      map[b].PF+=lb; map[b].PC+=la;
      if (la>lb){ map[a].PG++; map[b].PP++; } else if (la<lb){ map[b].PG++; map[a].PP++; }
    }
    const arr = Object.values(map).map(s=>({...s,DF:s.PF-s.PC,PTS:2*s.PG+1*s.PP}));
    arr.sort((x,y)=> y.PTS - x.PTS || y.DF - x.DF || y.PF - x.PF || x.nombre.localeCompare(y.nombre));
    return arr.map((r,i)=>({...r,pos:i+1}));
  }

  function renderStandings(matches){
    const s = aggregateStandings(matches);
    const container = document.getElementById('standingsTable'); container.innerHTML = '';
    if (!s.length){ container.innerHTML = '<div class="small">No hay datos</div>'; return; }
    const table = document.createElement('table'); table.className='table fade-in';
    const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Pos</th><th>Equipo</th><th>PJ</th><th>PG</th><th>PP</th><th>PF</th><th>PC</th><th>DF</th><th>PTS</th></tr>';
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    for (const r of s){
      const tr = document.createElement('tr');
      if (r.pos <= 8) tr.style.background='rgba(245,158,11,0.04)';
      tr.innerHTML = `<td>${r.pos}</td><td>${r.nombre}</td><td style="text-align:center">${r.PJ}</td><td style="text-align:center">${r.PG}</td><td style="text-align:center">${r.PP}</td><td style="text-align:center">${r.PF}</td><td style="text-align:center">${r.PC}</td><td style="text-align:center">${r.DF}</td><td style="text-align:center;font-weight:800">${r.PTS}</td>`;
      tbody.appendChild(tr);
    }
    table.appendChild(tbody); container.appendChild(table);
  }

  function setupJornadas(matches){
    jornadasSorted = [...new Set(matches.map(m=>m.jornada).filter(v=>v!=null))].sort((a,b)=>a-b);
    const sel = document.getElementById('jornadaSelect');
    sel.innerHTML = '';
    jornadasSorted.forEach(j => {
      const o = document.createElement('option'); o.value = j; o.textContent = 'Jornada ' + j; sel.appendChild(o);
    });
    if (jornadasSorted.length) currentJornada = jornadasSorted[0];
    sel.addEventListener('change', ()=> { currentJornada = Number(sel.value); renderFixture(latestMatches); });
    document.getElementById('prevJ').addEventListener('click', ()=>{
      if (!jornadasSorted.length) return;
      const idx = jornadasSorted.indexOf(currentJornada);
      if (idx > 0) currentJornada = jornadasSorted[idx-1];
      sel.value = currentJornada; renderFixture(latestMatches);
    });
    document.getElementById('nextJ').addEventListener('click', ()=>{
      if (!jornadasSorted.length) return;
      const idx = jornadasSorted.indexOf(currentJornada);
      if (idx < jornadasSorted.length - 1) currentJornada = jornadasSorted[idx+1];
      sel.value = currentJornada; renderFixture(latestMatches);
    });
  }

  function renderFixture(matches){
    setupJornadas(matches);
    const container = document.getElementById('fixtureList'); container.innerHTML = '';
    if (!currentJornada){ container.innerHTML = '<div class="small">No hay jornadas definidas.</div>'; return; }
    const block = document.createElement('div'); block.className='fade-in';
    const hdr = document.createElement('div'); hdr.style.display='flex'; hdr.style.justifyContent='space-between'; hdr.style.alignItems='center';
    hdr.innerHTML = `<strong>Jornada ${currentJornada}</strong><span class="small">${matches.filter(m=>m.jornada===currentJornada).length} partidos</span>`;
    block.appendChild(hdr);
    for (const m of matches.filter(x=>x.jornada===currentJornada)){
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='10px 6px';
      const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${m.equipo_local||'TBD'}</div>`;
      const center = document.createElement('div'); center.innerHTML = `<strong>${m.score_local!=null?m.score_local:'-'} — ${m.score_visita!=null?m.score_visita:'-'}</strong>`;
      const right = document.createElement('div'); right.innerHTML = `<div style="font-weight:700">${m.equipo_visita||'TBD'}</div><div class="small" style="color:var(--muted)">${m.cancha?m.cancha+' · ':''}${m.fecha?m.fecha+' ':''}${m.hora?m.hora:''}</div>`;
      row.appendChild(left); row.appendChild(center); row.appendChild(right);
      block.appendChild(row);
    }
    container.appendChild(block);
  }

  function winnerFromMatch(m){
    if (!m || m.score_local==null || m.score_visita==null) return null;
    return m.score_local > m.score_visita ? m.equipo_local : (m.score_visita > m.score_local ? m.equipo_visita : 'EMPATE');
  }

  function renderBracket(matches){
    const colQf = document.getElementById('bracket').children[0] || document.createElement('div');
    document.getElementById('bracket').innerHTML = '<div class="column" id="col-qf"></div><div class="column" id="col-sf"></div><div class="column" id="col-final"></div>';
    const colQ = document.getElementById('col-qf'), colS = document.getElementById('col-sf'), colF = document.getElementById('col-final');

    const stand = aggregateStandings(matches).slice(0,8);
    const explicitQF = matches.filter(m=>m.fase && m.fase.startsWith('QF')).sort((a,b)=>a.fase.localeCompare(b.fase));
    const explicitSF = matches.filter(m=>m.fase && m.fase.startsWith('SF')).sort((a,b)=>a.fase.localeCompare(b.fase));
    const explicitFinal = matches.filter(m=>m.fase && (m.fase==='FINAL' || m.fase==='F')).sort((a,b)=>a.id - b.id);

    if (!stand.length && !explicitQF.length){ colQ.innerHTML = '<div class="small">No hay equipos suficientes</div>'; return; }

    const pairsAuto = [
      [stand[0]||null, stand[7]||null],
      [stand[3]||null, stand[4]||null],
      [stand[2]||null, stand[5]||null],
      [stand[1]||null, stand[6]||null]
    ];

    // QF: use explicit rows if present, otherwise auto pairs
    const qfToRender = explicitQF.length ? explicitQF : pairsAuto.map((p,i)=>({fase:'QF'+(i+1), equipo_local: p[0]?p[0].nombre:'', equipo_visita: p[1]?p[1].nombre:''}));

    qfToRender.forEach((q,i)=>{
      const el = document.createElement('div'); el.className='match fade-in';
      let left = q.equipo_local || '';
      let right = q.equipo_visita || '';
      if (!left && !right && pairsAuto[i]){ left = pairsAuto[i][0] ? pairsAuto[i][0].nombre : 'TBD'; right = pairsAuto[i][1] ? pairsAuto[i][1].nombre : 'TBD'; }
      const score = (q.score_local!=null && q.score_visita!=null) ? `${q.score_local} — ${q.score_visita}` : '—';
      el.innerHTML = `<div style="font-weight:700">${left}</div><div class="small">${score}</div><div style="font-weight:700">${right}</div>`;
      colQ.appendChild(el);
    });

    // SF placeholders or explicit
    const sfToRender = explicitSF.length ? explicitSF : [{fase:'SF1'},{fase:'SF2'}];
    sfToRender.forEach((s,i)=>{
      const el = document.createElement('div'); el.className='match fade-in';
      let left = s.equipo_local || 'A confirmar', right = s.equipo_visita || 'A confirmar';
      const score = (s.score_local!=null && s.score_visita!=null) ? `${s.score_local} — ${s.score_visita}` : '—';
      el.innerHTML = `<div style="font-weight:700">${left}</div><div class="small">${score}</div><div style="font-weight:700">${right}</div>`;
      colS.appendChild(el);
    });

    // FINAL placeholder / explicit
    const finalToRender = explicitFinal.length ? explicitFinal[0] : {fase:'FINAL'};
    const fEl = document.createElement('div'); fEl.className='match fade-in';
    const fLeft = finalToRender.equipo_local || 'A confirmar', fRight = finalToRender.equipo_visita || 'A confirmar';
    const fScore = (finalToRender.score_local!=null && finalToRender.score_visita!=null) ? `${finalToRender.score_local} — ${finalToRender.score_visita}` : '—';
    fEl.innerHTML = `<div style="font-weight:700">${fLeft}</div><div class="small">${fScore}</div><div style="font-weight:700">${fRight}</div>`;
    colF.appendChild(fEl);

    // If explicit QF present and winners can be determined, auto-fill SF placeholders
    if (explicitQF.length){
      const qWinners = explicitQF.map(m => winnerFromMatch(m));
      if (qWinners.filter(Boolean).length >= 2){
        // map winners to SF: QF1 vs QF2 -> SF1 ; QF3 vs QF4 -> SF2
        const sf1left = qWinners[0] || 'A confirmar', sf1right = qWinners[1] || 'A confirmar';
        const sf2left = qWinners[2] || 'A confirmar', sf2right = qWinners[3] || 'A confirmar';
        colS.innerHTML = '';
        [ [sf1left,sf1right], [sf2left,sf2right] ].forEach(p=>{
          const el = document.createElement('div'); el.className='match fade-in'; el.innerHTML = `<div style="font-weight:700">${p[0]}</div><div class="small">—</div><div style="font-weight:700">${p[1]}</div>`; colS.appendChild(el);
        });
      }
      // if SF explicit present and have winners, fill final
      if (explicitSF.length){
        const sfW = explicitSF.map(m=> winnerFromMatch(m));
        if (sfW.filter(Boolean).length === 2){
          colF.innerHTML = '';
          const el2 = document.createElement('div'); el2.className='match fade-in'; el2.innerHTML = `<div style="font-weight:700">${sfW[0]}</div><div class="small">—</div><div style="font-weight:700">${sfW[1]}</div>`; colF.appendChild(el2);
        }
      }
    }
  }

  function parseScorersField(field){
    if (!field) return [];
    return field.split(';').map(s=>s.trim()).filter(Boolean).map(part=>{
      const [name, pts] = part.split(':').map(x=>x && x.trim());
      return { name: name||'', pts: pts ? Number(pts) : 0 };
    });
  }
  function renderGoleadores(matches){
    const box = document.getElementById('goleadoresBox'); box.innerHTML = '';
    const tally = {};
    for (const m of matches){
      const left = parseScorersField(m.goleadores_local);
      const right = parseScorersField(m.goleadores_visita);
      for (const s of [...left,...right]){ if (!s.name) continue; tally[s.name] = (tally[s.name] || 0) + (Number.isFinite(Number(s.pts)) ? Number(s.pts) : 0); }
    }
    const arr = Object.keys(tally).map(n=>({nombre:n,pts:tally[n]})).sort((a,b)=>b.pts - a.pts || a.nombre.localeCompare(b.nombre));
    if (!arr.length){ box.innerHTML = '<div class="small">Aún no hay datos de goleadores.</div>'; return; }
    const table = document.createElement('table'); table.className='table fade-in';
    table.innerHTML = '<thead><tr><th>#</th><th>Jugador</th><th>Puntos</th></tr></thead>';
    const tbody = document.createElement('tbody');
    arr.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${r.nombre}</td><td style="text-align:right">${r.pts}</td>`; tbody.appendChild(tr); });
    table.appendChild(tbody); box.appendChild(table);
  }

  function renderAll(matches){
    renderStandings(matches);
    renderFixture(matches);
    renderBracket(matches);
    renderGoleadores(matches);
  }

  const navBtns = document.querySelectorAll('.nav-btn');
  navBtns.forEach(b=> b.addEventListener('click', e=>{
    navBtns.forEach(x=>x.classList.remove('active')); e.currentTarget.classList.add('active');
    const tab = e.currentTarget.getAttribute('data-tab');
    document.querySelectorAll('main section').forEach(s=>s.style.display='none');
    document.getElementById(tab).style.display='block';
  }));
  const topNavBtns = document.querySelectorAll('.topnav button');
  topNavBtns.forEach(b=> b.addEventListener('click', e=>{ document.querySelectorAll('main section').forEach(s=>s.style.display='none'); document.getElementById(e.currentTarget.getAttribute('data-tab')).style.display='block'; }));

  function getCsvParam(){ try{ const params = new URLSearchParams(window.location.search); const csvParam = params.get('csv'); return csvParam ? decodeURIComponent(csvParam) : null; } catch(e){ return null; } }
  (function init(){
    const param = getCsvParam();
    if (param){ let dec = param; try{ dec = decodeURIComponent(param);}catch(e){} saveUrl(dec); fetchAndRender(dec); }
    else {
      const s = loadSaved();
      if (s) fetchAndRender(s);
      else if (DEFAULT_CSV) { saveUrl(DEFAULT_CSV); fetchAndRender(DEFAULT_CSV); }
    }
    // auto-refresh ON by default
    document.getElementById('autoRefresh').checked = true;
    startAutoRefresh(30);
    // mobile nav show
    if (window.innerWidth <= 880) document.querySelector('.topnav').style.display = 'flex';
  })();

  window.torneo = { fetchAndRender };
})();
</script>
</body>
</html>
